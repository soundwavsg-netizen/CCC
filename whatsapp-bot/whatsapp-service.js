const { makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys')
const express = require('express')
const cors = require('cors')
const axios = require('axios')

const app = express()
app.use(cors())
app.use(express.json())

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8001'

let sock = null
let qrCode = null
let connectionStatus = 'disconnected'
let conversationHistory = {} // Track conversation per phone number

async function initWhatsApp() {
    try {
        console.log('üöÄ Initializing CCC Digital WhatsApp Bot...')
        
        const { state, saveCreds } = await useMultiFileAuthState('./auth_info')

        sock = makeWASocket({
            auth: state,
            printQRInTerminal: true,
            browser: ['CCC Digital Bot', 'Chrome', '1.0.0'],
            generateHighQualityLinkPreview: true
        })

        sock.ev.on('connection.update', async (update) => {
            const { connection, lastDisconnect, qr } = update

            if (qr) {
                qrCode = qr
                console.log('üì± QR Code generated - scan with WhatsApp to connect')
            }

            if (connection === 'close') {
                const shouldReconnect = (lastDisconnect?.error)?.output?.statusCode !== DisconnectReason.loggedOut
                console.log('Connection closed:', lastDisconnect?.error, '| Reconnecting:', shouldReconnect)
                connectionStatus = 'disconnected'

                if (shouldReconnect) {
                    setTimeout(initWhatsApp, 5000)
                }
            } else if (connection === 'open') {
                console.log('‚úÖ CCC Digital WhatsApp Bot connected successfully!')
                console.log('üìû Business number: +65 8982 1301')
                qrCode = null
                connectionStatus = 'connected'
            }
        })

        sock.ev.on('messages.upsert', async ({ messages, type }) => {
            if (type === 'notify') {
                for (const message of messages) {
                    if (!message.key.fromMe && message.message) {
                        await handleIncomingMessage(message)
                    }
                }
            }
        })

        sock.ev.on('creds.update', saveCreds)

    } catch (error) {
        console.error('‚ùå WhatsApp initialization error:', error)
        connectionStatus = 'error'
        setTimeout(initWhatsApp, 10000)
    }
}

async function handleIncomingMessage(message) {
    try {
        const phoneNumber = message.key.remoteJid.replace('@s.whatsapp.net', '')
        const messageText = message.message.conversation ||
                           message.message.extendedTextMessage?.text || ''

        console.log(`üì® Message from ${phoneNumber}: ${messageText}`)

        const response = await processCCCMessage(phoneNumber, messageText)

        if (response) {
            await sendMessage(phoneNumber, response)
        }

    } catch (error) {
        console.error('‚ùå Error handling message:', error)
        await sendMessage(phoneNumber.replace('@s.whatsapp.net', ''), 
            "Sorry, I encountered a technical issue. Please call us at +65 8982 1301.")
    }
}

async function processCCCMessage(phoneNumber, messageText) {
    const text = messageText.toLowerCase().trim()
    
    // Initialize conversation history for this number
    if (!conversationHistory[phoneNumber]) {
        conversationHistory[phoneNumber] = {
            responses: [],
            lastResponseType: null,
            clarificationCount: 0
        }
    }
    
    const history = conversationHistory[phoneNumber]

    // 1. QUOTE REQUESTS - Always handle first
    if (text.includes('quote')) {
        if (text.includes('quote chatbot') || text.includes('quote ai')) {
            const response = `‚úÖ **AI Chatbot Quote Request Received!**

Our team will prepare a detailed chatbot proposal and contact you within 1 business day and may contact you for more details to furnish a detailed quote.

**We'll include:**
‚Ä¢ Custom chatbot features for your business
‚Ä¢ Integration requirements
‚Ä¢ EDG funding calculation
‚Ä¢ Implementation timeline

**Business hours:** Mon-Fri 9AM-6PM SGT

Thank you for choosing CCC! üöÄ

**Feel free to ask me more questions while you wait! üòä**`
            history.responses.push('quote_acknowledgment')
            return response
        }
        
        const response = `‚úÖ **Quote Request Received!**

Our team will prepare a customized proposal and contact you within 1 business day and may contact you for more details to furnish a detailed quote.

**Business hours:** Mon-Fri 9AM-6PM SGT

Thank you for choosing CCC! üöÄ

**Feel free to ask me more questions while you wait! üòä**`
        history.responses.push('quote_acknowledgment')
        return response
    }

    // 2. WELCOME
    if (text === 'hi' || text === 'hello' || text === 'start') {
        history.responses.push('welcome')
        return `üëã Hi there! Welcome to CCC!

I'm here to help with your digital business needs.

**What brings you here today?**
‚Ä¢ Looking to build a website?
‚Ä¢ Want to set up online sales?
‚Ä¢ Need business automation?
‚Ä¢ Curious about government grants?
‚Ä¢ Or something else entirely?

Let me know what you're thinking about!`
    }

    // 3. SERVICES INQUIRY
    if (text.includes('tell me about') || text.includes('your services') || text.includes('what do you offer') || 
        text.includes('what services') || text.includes('what can you do')) {
        history.responses.push('services_overview')
        return `üöÄ **CCC helps Singapore businesses go digital:**

**Our specialties:**
‚Ä¢ Professional websites & web apps
‚Ä¢ E-commerce & online stores  
‚Ä¢ Business automation & AI
‚Ä¢ Government grant applications (EDG)

**We help businesses:**
‚Ä¢ Get more customers online
‚Ä¢ Streamline operations
‚Ä¢ Access government funding

What type of business do you run? I can suggest the perfect solution!`
    }

    // 4. BUSINESS-SPECIFIC RESPONSES (Handle specific industries)
    if (text.includes('teaching') || text.includes('school') || text.includes('education') || text.includes('courses') || text.includes('tuition')) {
        history.responses.push('education_business')
        return `üè´ **Perfect! For teaching schools & education businesses:**

**Website + Course Management:**
‚Ä¢ Student registration & course booking
‚Ä¢ Online course materials & resources
‚Ä¢ Parent communication portal
‚Ä¢ Schedule management
‚Ä¢ Payment processing for courses

**Popular for:** Tuition centers, training schools, enrichment programs

**With EDG support, development costs can be 50% lower!**

**What subjects do you teach?** This helps me recommend specific features like:
‚Ä¢ Student progress tracking
‚Ä¢ Online assignments & homework
‚Ä¢ Video lesson integration
‚Ä¢ Automated class reminders

Want a detailed proposal? Type "quote education"`
    }

    // 5. WEBSITE INQUIRIES
    if (text.includes('website') || text === '1') {
        if (history.responses.includes('website_features')) {
            // Different response if already explained websites
            return `üåê **Let me be more specific about websites:**

**What's your main goal?**
‚Ä¢ Get more customers to find you?
‚Ä¢ Showcase your work/products?
‚Ä¢ Accept bookings or appointments?
‚Ä¢ Sell products online?
‚Ä¢ Build trust & credibility?

Knowing your goal helps me recommend the right features and approach.`
        } else {
            history.responses.push('website_features')
            return `üåê **AI-Powered Websites:**

**Perfect for businesses wanting:**
‚Ä¢ Professional online presence
‚Ä¢ Lead generation from Google
‚Ä¢ Customer contact & trust building
‚Ä¢ Showcase products/services

**Key features:**
‚Ä¢ Mobile-responsive design
‚Ä¢ AI chat integration (like this!)
‚Ä¢ Easy content management
‚Ä¢ SEO optimization
‚Ä¢ Contact forms & analytics

**What industry is your business in?** I can share specific examples.`
        }
    }

    // 6. PRICING REQUESTS
    if (text.includes('pricing') || text.includes('how much') || text.includes('cost')) {
        history.responses.push('pricing_shown')
        return `üí∞ **CCC Investment Guide:**

üåê **Websites:** $3K-$12K *(with EDG: $1.5K-$6K)*
üõí **E-commerce:** $6K-$18K *(with EDG: $3K-$9K)*  
üì± **Web Apps:** $8.5K-$24K *(with EDG: $4.25K-$12K)*
ü§ñ **AI & Automation:** $1.8K-$8.8K *(with EDG: $0.9K-$4.4K)*

**EDG funding covers up to 50% for qualifying Singapore companies!**

Which service fits your business needs?`
    }

    // 7. SMART CLARIFICATION - Different responses based on attempts
    if (history.clarificationCount >= 2) {
        // After 2 clarification attempts, offer human help
        return `üë®‚Äçüíº **Let me connect you with our human consultant!**

I want to make sure you get the best help possible.

**Our team can discuss:**
‚Ä¢ Your specific business needs
‚Ä¢ Tailored solution recommendations  
‚Ä¢ Exact pricing for your project
‚Ä¢ EDG funding eligibility

**Call directly: +65 8982 1301**
**Or share your name & number, and we'll call you back today!**`
    } else if (history.clarificationCount === 1) {
        // Second clarification - more direct
        history.clarificationCount++
        return `üí° **Let me try a different approach:**

**What's your business?** (e.g., restaurant, retail store, consultancy)
**What's your biggest challenge?** (e.g., need more customers, want online sales)

**Or pick a topic:**
‚Ä¢ Website for my business
‚Ä¢ Online store setup  
‚Ä¢ AI automation
‚Ä¢ Government funding

**Quick call works best: +65 8982 1301**`
    } else {
        // First clarification
        history.clarificationCount++
        return `ü§î Let me help you find the right solution!

**Could you share more about:**
‚Ä¢ What type of business you have?
‚Ä¢ What challenge you're trying to solve?
‚Ä¢ What you hope to achieve?

**Examples:**
"I run a restaurant and need more online orders"
"I have a retail store wanting online sales"
"I need to automate my customer service"

**For immediate help, call: +65 8982 1301**`
    }
}

async function sendMessage(phoneNumber, text) {
    try {
        if (!sock) {
            throw new Error('WhatsApp not connected')
        }

        const jid = phoneNumber.includes('@') ? phoneNumber : `${phoneNumber}@s.whatsapp.net`
        await sock.sendMessage(jid, { text })
        console.log(`‚úÖ Message sent to ${phoneNumber}`)
        return { success: true }

    } catch (error) {
        console.error('‚ùå Error sending message:', error)
        return { success: false, error: error.message }
    }
}

// REST API endpoints
app.get('/qr', (req, res) => {
    res.json({ qr: qrCode })
})

app.get('/status', (req, res) => {
    res.json({
        connected: connectionStatus === 'connected',
        status: connectionStatus,
        user: sock?.user || null,
        business_number: '+65 8982 1301'
    })
})

const PORT = process.env.PORT || 3001
app.listen(PORT, () => {
    console.log(`ü§ñ CCC Digital WhatsApp Bot running on port ${PORT}`)
    console.log(`üìû Business number: +65 8982 1301`)
    initWhatsApp()
})